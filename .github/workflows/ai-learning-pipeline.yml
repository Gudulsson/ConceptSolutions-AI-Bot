name: AI Learning Pipeline - ConceptSolutions

on:
  workflow_dispatch:
    inputs:
      learning_duration:
        description: 'Learning duration in hours (max 6 for GitHub Actions)'
        required: true
        default: '4'
        type: string
      search_web:
        description: 'Search web for keywords and themes'
        required: true
        default: 'true'
        type: string
      publish_articles:
        description: 'Publish improved articles'
        required: true
        default: 'false'
        type: string

  schedule:
    # KÃ¶r varje dag kl 06:00 UTC
    - cron: '0 6 * * *'

  push:
    branches: [ main ]
    paths:
      - 'ai-self-improvement-engine.js'
      - 'services/ai-engine.js'
      - '.github/workflows/ai-learning-pipeline.yml'

jobs:
  ai-learning:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 timmar max fÃ¶r GitHub Actions
    
    strategy:
      matrix:
        node-version: [18.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Setup environment variables
      run: |
        echo "WORDPRESS_URL=${{ secrets.WORDPRESS_URL }}" >> $GITHUB_ENV
        echo "WORDPRESS_USERNAME=${{ secrets.WORDPRESS_USERNAME }}" >> $GITHUB_ENV
        echo "WORDPRESS_PASSWORD=${{ secrets.WORDPRESS_PASSWORD }}" >> $GITHUB_ENV
        echo "WOOCOMMERCE_CONSUMER_KEY=${{ secrets.WOOCOMMERCE_CONSUMER_KEY }}" >> $GITHUB_ENV
        echo "WOOCOMMERCE_CONSUMER_SECRET=${{ secrets.WOOCOMMERCE_CONSUMER_SECRET }}" >> $GITHUB_ENV
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
        echo "SERPAPI_KEY=${{ secrets.SERPAPI_KEY }}" >> $GITHUB_ENV
        
    - name: Run AI Learning Engine
      run: |
        echo "ðŸš€ STARTAR AI LÃ„RANDE PIPELINE"
        echo "â±ï¸  KÃ¶rtid: ${{ github.event.inputs.learning_duration || '4' }} timmar"
        echo "ðŸŒ WebbsÃ¶kning: ${{ github.event.inputs.search_web || 'true' }}"
        echo "ðŸ“ Publicera artiklar: ${{ github.event.inputs.publish_articles || 'false' }}"
        
        # KÃ¶r AI learning engine direkt (utan localhost beroenden)
        node ai-self-improvement-engine.js --duration=${{ github.event.inputs.learning_duration || '4' }} --web-search=${{ github.event.inputs.search_web || 'true' }} --publish=${{ github.event.inputs.publish_articles || 'false' }}
        
    - name: Generate learning report
      run: |
        echo "ðŸ“Š Genererar lÃ¤randerapport..."
        if [ -f "generate-learning-report.js" ]; then
          node generate-learning-report.js
        else
          echo "ðŸ“‹ Skapar enkel rapport..."
          echo "# AI Learning Report" > AI-LEARNING-REPORT.md
          echo "Generated: $(date)" >> AI-LEARNING-REPORT.md
          echo "Duration: ${{ github.event.inputs.learning_duration || '4' }} hours" >> AI-LEARNING-REPORT.md
        fi
        
    - name: Upload learning artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ai-learning-results
        path: |
          ai-knowledge-base.json
          ai-learning-report.json
          ai-improvement-log.json
          AI-LEARNING-REPORT.md
          generated-content/
          
    - name: Commit and push improvements
      run: |
        git config --local user.email "ai@conceptsolutions.se"
        git config --local user.name "ConceptSolutions AI"
        
        if [ -f ai-knowledge-base.json ]; then
          git add ai-knowledge-base.json
          git commit -m "ðŸ¤– AI Learning Update - $(date)" || echo "No changes to commit"
        fi
        
        if [ -f ai-learning-report.json ]; then
          git add ai-learning-report.json
          git commit -m "ðŸ“Š AI Learning Report - $(date)" || echo "No changes to commit"
        fi
        
        if [ -f AI-LEARNING-REPORT.md ]; then
          git add AI-LEARNING-REPORT.md
          git commit -m "ðŸ“‹ AI Learning Report Markdown - $(date)" || echo "No changes to commit"
        fi
        
        git push origin main || echo "No changes to push"
        
    - name: Create summary comment
      if: github.event_name == 'workflow_dispatch'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let summary = '## ðŸ¤– AI Learning Pipeline Complete\n\n';
          summary += `**Duration:** ${context.payload.inputs.learning_duration || '4'} hours\n`;
          summary += `**Web Search:** ${context.payload.inputs.search_web || 'true'}\n`;
          summary += `**Publish Articles:** ${context.payload.inputs.publish_articles || 'false'}\n\n`;
          
          try {
            if (fs.existsSync('ai-knowledge-base.json')) {
              const knowledge = JSON.parse(fs.readFileSync('ai-knowledge-base.json', 'utf8'));
              summary += `**Learning Cycles:** ${knowledge.learningCycles || 0}\n`;
              summary += `**Pages Analyzed:** ${knowledge.websiteKnowledge?.pages?.length || 0}\n`;
              summary += `**Products Analyzed:** ${knowledge.websiteKnowledge?.products?.length || 0}\n`;
            }
          } catch (error) {
            summary += '**Status:** Learning completed\n';
          }
          
          summary += '\n### ðŸŽ¯ Key Insights\n';
          summary += '- AI has analyzed website content and structure\n';
          summary += '- Identified content gaps and improvement opportunities\n';
          summary += '- Generated SEO and performance recommendations\n';
          summary += '- Updated knowledge base with new insights\n';
          
          // Skapa en issue istÃ¤llet fÃ¶r comment eftersom det inte finns ett issue nummer
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸ¤– AI Learning Report - ${new Date().toLocaleDateString()}`,
            body: summary,
            labels: ['ai-learning', 'automation']
          });
